import{r as c,j as a,G as ye,i as e,m as W,a6 as ee,cs as ge,er as je,bg as Ce,a5 as re,am as de,ci as te,cT as V,Z as Ae,ad as Ie,bI as R,em as Re,S as we}from"./vendor-BnaqX2_l.js";import{A as Fe}from"./AdminButton-GD-Bfrm9.js";import{P as Z}from"./PrimaryActionButton-DmbHLQKT.js";import{u as ce,h as pe,R as me,j as Oe,a as Pe,I as ue,k as De,P as Ee}from"./InvenTreeTable-rEa-i3pt.js";import{I as Me,D as H,a as Te}from"./InstanceDetail-DvLVYRQt.js";import{D as ve,N as Le}from"./NotesPanel-Dh1SrbjV.js";import{B as Ne,O as qe,E as Be,a as Ge,H as We,C as He}from"./ActionDropdown-D1A3arjv.js";import{d as _e,C as Ue,S as se}from"./BaseContext-CH9A7-TB.js";import{P as ze}from"./PageDetail-Ct_zKLxm.js";import{A as Ke}from"./AttachmentPanel-Ct80LGG4.js";import{P as Ve}from"./PanelGroup-CKTRVRga.js";import{S as Ze}from"./Instance-DrUTN1gu.js";import{b as Y}from"./formatters-DBeaC9UC.js";import{a as X,A as o,m as d,U as r,e as w,l as Ye}from"./index-fPzgLVil.js";import{b as ae,c as Qe,d as Xe,e as ie,f as Je,u as le}from"./SalesOrderForms-CNvk5nqw.js";import{u as x,a as J,b as he,A as be,c as oe}from"./UseForm-DwZIxEnj.js";import{u as $e}from"./UseInstance-DbDyyJjp.js";import{u as et}from"./UseStatusCodes-CE5Vxrbg.js";import{u as tt,B as st}from"./BuildOrderTable-CYnZPUJ-.js";import{E as at}from"./ExtraLineItemTable-BjFa9xNb.js";import{S as xe}from"./SalesOrderAllocationTable-C1XN-9wZ.js";import{a as it,i as Q,f as lt,P as ne,L as ke}from"./ColumnRenderers-6jyK6a0i.js";import{O as ot}from"./OrderPartsWizard-BFgDSSVd.js";import{R as nt}from"./RowExpansionIcon-qojre285.js";import{Y as rt}from"./YesNoButton-W51do83Q.js";import"./DesktopAppView-CAvOv5f4.js";import"./navigation-B-mN4luC.js";import"./dayjs.min-DlCiWWGX.js";import"./GenericErrorPage-BDqvbBMU.js";import"./NotFound-Dr2EC1Qm.js";import"./PermissionDenied-BHX44oqK.js";import"./PageTitle-AnZP781e.js";import"./AttachmentLink-BJMgqQK8.js";import"./ApiIcon-Bqf-O7I2.js";import"./RemoteComponent-Who-27QQ.js";import"./RemoveRowButton-Dm_wD7jw.js";import"./UseGenerator-DOw_SLei.js";import"./UsePlaceholder-Dc_Ugorx.js";import"./UseFilter-qbbXWiSh.js";import"./CommonForms-D6scP564.js";import"./CompanyForms-yUzzFM8E.js";import"./PurchaseOrderForms-DPVzsVCo.js";function dt({orderId:p,currency:m,customerId:g,editable:t}){const _=_e(),i=X(),l=ce("sales-order-line-item"),k=c.useMemo(()=>[{accessor:"part",sortable:!0,switchable:!1,render:s=>a.jsxs(ye,{wrap:"nowrap",children:[a.jsx(nt,{enabled:s.allocated,expanded:l.isRowExpanded(s.pk)}),a.jsx(it,{part:s.part_detail})]})},{accessor:"part_detail.IPN",title:e._({id:"3wXEsN"}),switchable:!0},{accessor:"part_detail.description",title:e._({id:"Nu4oKW"}),sortable:!1,switchable:!0},{accessor:"reference",sortable:!1,switchable:!0},{accessor:"quantity",sortable:!0},{accessor:"sale_price",render:s=>Y(s.sale_price,{currency:s.sale_price_currency})},{accessor:"total_price",title:e._({id:"KyZVKD"}),render:s=>Y(s.sale_price,{currency:s.sale_price_currency,multiplier:s.quantity})},Q({accessor:"target_date",sortable:!0,title:e._({id:"ZmykKo"})}),{accessor:"stock",title:e._({id:"oGd3rK"}),render:s=>{const D=(s==null?void 0:s.available_stock)??0,L=(s==null?void 0:s.available_variant_stock)??0,E=D+L,B=Math.max(s.quantity-s.allocated-s.shipped,0);let K,$=`${E}`;const G=[];return E<=0?(K="red",$=e._({id:"a5n/wL"})):E<B&&(K="orange"),L>0&&G.push(a.jsx(W,{size:"sm",children:e._({id:"LdvJ9e"})})),s.building>0&&G.push(a.jsxs(W,{size:"sm",children:[e._({id:"G1xXyB"}),": ",s.building]})),s.on_order>0&&G.push(a.jsxs(W,{size:"sm",children:[e._({id:"/MB+gl"}),": ",s.on_order]})),a.jsx(lt,{value:a.jsx(W,{c:K,children:$}),extra:G,title:e._({id:"odasNw"})})}},{accessor:"allocated",sortable:!0,render:s=>a.jsx(ne,{progressLabel:!0,value:s.allocated,maximum:s.quantity})},{accessor:"shipped",sortable:!0,render:s=>a.jsx(ne,{progressLabel:!0,value:s.shipped,maximum:s.quantity})},{accessor:"notes"},ke({accessor:"link"})],[l.isRowExpanded]),[j,n]=c.useState(0),[f,b]=c.useState({}),F=ae({orderId:p,customerId:g,create:!0}),S=x({url:o.sales_order_line_list,title:e._({id:"pwb7Yo"}),fields:F,initialData:{...f,sale_price_currency:m},table:l}),M=ae({orderId:p,customerId:g,create:!1}),C=J({url:o.sales_order_line_list,pk:j,title:e._({id:"vgosWS"}),fields:M,table:l}),A=he({url:o.sales_order_line_list,pk:j,title:e._({id:"tpKh8C"}),table:l}),h=Qe({itemId:j,orderId:p}),y=x({url:o.sales_order_allocate_serials,pk:p,title:e._({id:"AZE5KS"}),initialData:f,fields:h,table:l}),N=tt({create:!0}),q=x({url:o.build_order_list,title:e._({id:"UcPKar"}),fields:N,initialData:f,follow:!0,modelType:d.build}),[U,T]=c.useState([]),u=Xe({orderId:p,lineItems:U,onFormSuccess:()=>{l.refreshTable(),l.clearSelectedRecords()}}),[v,O]=c.useState([]),I=ot({parts:v}),P=c.useMemo(()=>[{name:"allocated",label:e._({id:"A/ybx7"}),description:e._({id:"Rk+ZGQ"})},{name:"completed",label:e._({id:"qqWcBV"}),description:e._({id:"x7Nm8D"})}],[]),z=c.useMemo(()=>[a.jsx(be,{tooltip:e._({id:"pwb7Yo"}),onClick:()=>{b({order:p}),S.open()},hidden:!t||!i.hasAddRole(r.sales_order)},"add-line-item"),a.jsx(oe,{hidden:!i.hasAddRole(r.purchase_order),disabled:!l.hasSelectedRecords,tooltip:e._({id:"3u5ICq"}),icon:a.jsx(ee,{}),color:"blue",onClick:()=>{O(l.selectedRecords.map(s=>s.part_detail)),I.openWizard()}},"order-parts"),a.jsx(oe,{tooltip:e._({id:"L1LMmH"}),icon:a.jsx(ge,{}),disabled:!l.hasSelectedRecords,color:"green",onClick:()=>{T(l.selectedRecords.filter(s=>s.allocated<s.quantity)),u.open()}},"allocate-stock")],[i,p,l.hasSelectedRecords,l.selectedRecords]),fe=c.useCallback(s=>{var L,E,B;const D=((s==null?void 0:s.allocated)??0)>((s==null?void 0:s.quantity)??0);return[pe({title:e._({id:"4BxQBj"}),modelType:d.part,modelId:s.part,navigate:_,hidden:!i.hasViewRole(r.part)}),{hidden:D||!t||!i.hasChangeRole(r.sales_order),title:e._({id:"L1LMmH"}),icon:a.jsx(je,{}),color:"green",onClick:()=>{T([s]),u.open()}},{hidden:!((L=s==null?void 0:s.part_detail)!=null&&L.trackable)||D||!t||!i.hasChangeRole(r.sales_order),title:e._({id:"EIkxpC"}),icon:a.jsx(Ce,{}),color:"green",onClick:()=>{n(s.pk),b({quantity:s.quantity-s.allocated}),y.open()}},{hidden:D||!i.hasAddRole(r.build)||!((E=s==null?void 0:s.part_detail)!=null&&E.assembly),title:e._({id:"NH34YB"}),icon:a.jsx(re,{}),color:"blue",onClick:()=>{b({part:s.part,quantity:((s==null?void 0:s.quantity)??1)-((s==null?void 0:s.allocated)??0),sales_order:p}),q.open()}},{hidden:D||!i.hasAddRole(r.purchase_order)||!((B=s==null?void 0:s.part_detail)!=null&&B.purchaseable),title:e._({id:"G4SnGh"}),icon:a.jsx(ee,{}),color:"blue",onClick:()=>{O([s.part_detail]),I.openWizard()}},me({hidden:!t||!i.hasChangeRole(r.sales_order),onClick:()=>{n(s.pk),C.open()}}),Oe({hidden:!t||!i.hasAddRole(r.sales_order),onClick:()=>{b(s),S.open()}}),Pe({hidden:!t||!i.hasDeleteRole(r.sales_order),onClick:()=>{n(s.pk),A.open()}})]},[_,i,t]),Se=c.useMemo(()=>({allowMultiple:!0,expandable:({record:s})=>l.isRowExpanded(s.pk)||s.allocated>0,content:({record:s})=>a.jsx(xe,{showOrderInfo:!1,showPartInfo:!1,orderId:p,lineItemId:s.pk,partId:s.part,allowEdit:!0,isSubTable:!0})}),[p,l.isRowExpanded]);return a.jsxs(a.Fragment,{children:[C.modal,A.modal,S.modal,q.modal,y.modal,u.modal,I.wizard,a.jsx(ue,{url:w(o.sales_order_line_list),tableState:l,columns:k,props:{enableSelection:!0,enableDownload:!0,params:{order:p,part_detail:!0},rowActions:fe,tableActions:z,tableFilters:P,rowExpansion:Se}})]})}function ct({orderId:p}){const m=X(),g=_e(),t=ce("sales-order-shipment"),[_,i]=c.useState({}),l=ie({}),k=ie({}),j=Je({}),n=x({url:o.sales_order_shipment_list,fields:l,title:e._({id:"qU3Y7+"}),table:t,initialData:{order:p}}),f=he({url:o.sales_order_shipment_list,pk:_.pk,title:e._({id:"YAsuZ2"}),table:t}),b=J({url:o.sales_order_shipment_list,pk:_.pk,fields:k,title:e._({id:"rX/5YH"}),table:t}),F=x({url:o.sales_order_shipment_complete,pk:_.pk,fields:j,title:e._({id:"/IxVda"}),table:t,focus:"tracking_number",initialData:{..._,shipment_date:new Date().toISOString().split("T")[0]}}),S=c.useMemo(()=>[{accessor:"reference",title:e._({id:"Dwgrby"}),switchable:!1,sortable:!0},{accessor:"allocated_items",sortable:!0,switchable:!1,title:e._({id:"BzfzPK"})},{accessor:"shipped",title:e._({id:"AoOqHM"}),switchable:!0,sortable:!1,render:h=>a.jsx(rt,{value:!!h.shipment_date})},Q({accessor:"shipment_date",title:e._({id:"MFQxyA"})}),Q({accessor:"delivery_date",title:e._({id:"ovm9ir"})}),{accessor:"tracking_number"},{accessor:"invoice_number"},ke({accessor:"link"})],[]),M=c.useCallback(h=>{const y=!!h.shipment_date;return[pe({title:e._({id:"GtJdx7"}),modelType:d.salesordershipment,modelId:h.pk,navigate:g}),{hidden:y||!m.hasChangeRole(r.sales_order),title:e._({id:"/IxVda"}),color:"green",icon:a.jsx(de,{}),onClick:()=>{i(h),F.open()}},me({hidden:!m.hasChangeRole(r.sales_order),tooltip:e._({id:"MPjEsC"}),onClick:()=>{i(h),b.open()}}),De({hidden:y||!m.hasDeleteRole(r.sales_order),tooltip:e._({id:"whI1i/"}),onClick:()=>{i(h),f.open()}})]},[m]),C=c.useMemo(()=>[a.jsx(be,{tooltip:e._({id:"77d67d"}),hidden:!m.hasAddRole(r.sales_order),onClick:()=>{n.open()}},"add-shipment")],[m]),A=c.useMemo(()=>[{name:"shipped",label:e._({id:"AoOqHM"}),description:e._({id:"zxYkrg"})},{name:"delivered",label:e._({id:"BTOhSm"}),description:e._({id:"DOexmc"})}],[]);return a.jsxs(a.Fragment,{children:[n.modal,b.modal,f.modal,F.modal,a.jsx(ue,{url:w(o.sales_order_shipment_list),tableState:t,columns:S,props:{tableActions:C,tableFilters:A,modelType:d.salesordershipment,enableSelection:!0,enableReports:!0,rowActions:M,params:{order:p}}})]})}function $t(){var T;const{id:p}=Ue(),m=X(),g=Ye(),{instance:t,instanceQuery:_,refreshInstance:i,requestStatus:l}=$e({endpoint:o.sales_order_list,pk:p,params:{customer_detail:!0}}),k=c.useMemo(()=>{var u;return t.order_currency||((u=t.customer_detail)==null?void 0:u.currency)||g.getSetting("INVENTREE_DEFAULT_CURRENCY")},[t,g]),j=c.useMemo(()=>{var P;if(_.isFetching)return a.jsx(te,{});const u=[{type:"text",name:"reference",label:e._({id:"N2C89m"}),copy:!0},{type:"text",name:"customer_reference",label:e._({id:"ZVUe1A"}),copy:!0,icon:"reference",hidden:!t.customer_reference},{type:"link",name:"customer",icon:"customers",label:e._({id:"876pfE"}),model:d.company},{type:"text",name:"description",label:e._({id:"Nu4oKW"}),copy:!0},{type:"status",name:"status",label:e._({id:"uAQUqI"}),model:d.salesorder},{type:"status",name:"status_custom_key",label:e._({id:"4DvUAJ"}),model:d.salesorder,icon:"status",hidden:!t.status_custom_key||t.status_custom_key==t.status}],v=[{type:"progressbar",name:"completed",icon:"progress",label:e._({id:"qgs95u"}),total:t.line_items,progress:t.completed_lines,hidden:!t.line_items},{type:"progressbar",name:"shipments",icon:"shipment",label:e._({id:"polrQd"}),total:t.shipments_count,progress:t.completed_shipments_count,hidden:!t.shipments_count},{type:"text",name:"currency",label:e._({id:"0UZTSq"}),value_formatter:()=>k},{type:"text",name:"total_price",label:e._({id:"A6C0pv"}),value_formatter:()=>Y(t==null?void 0:t.total_price,{currency:k})}],O=[{type:"link",external:!0,name:"link",label:e._({id:"yzF66j"}),copy:!0,hidden:!t.link},{type:"link",model:d.contact,link:!1,name:"contact",label:e._({id:"jfC/xh"}),icon:"user",copy:!0,hidden:!t.contact},{type:"text",name:"project_code_label",label:e._({id:"Sdfr6G"}),icon:"reference",copy:!0,hidden:!t.project_code}],I=[{type:"date",name:"creation_date",label:e._({id:"FNcMGM"}),copy:!0,hidden:!t.creation_date},{type:"date",name:"issue_date",label:e._({id:"M1cChr"}),icon:"calendar",copy:!0,hidden:!t.issue_date},{type:"date",name:"target_date",label:e._({id:"ZmykKo"}),hidden:!t.target_date,copy:!0},{type:"date",name:"shipment_date",label:e._({id:"41ha49"}),hidden:!t.shipment_date,copy:!0},{type:"text",name:"responsible",label:e._({id:"XQACoK"}),badge:"owner",hidden:!t.responsible}];return a.jsxs(Me,{children:[a.jsxs(V,{children:[a.jsx(V.Col,{span:4,children:a.jsx(ve,{appRole:r.purchase_order,apiPath:o.company_list,src:(P=t.customer_detail)==null?void 0:P.image,pk:t.customer})}),a.jsx(V.Col,{span:8,children:a.jsx(H,{fields:u,item:t})})]}),a.jsx(H,{fields:v,item:t}),a.jsx(H,{fields:O,item:t}),a.jsx(H,{fields:I,item:t})]})},[t,k,_]),n=et({modelType:d.salesorder}),f=le({}),b=J({url:o.sales_order_list,pk:t.pk,title:e._({id:"nEK4wx"}),fields:f,onFormSuccess:()=>{i()}}),F=le({duplicateOrderId:t.pk}),S=x({url:o.sales_order_list,title:e._({id:"VzdnWM"}),fields:F,initialData:{...t,reference:void 0},follow:!0,modelType:d.salesorder}),M=c.useMemo(()=>[{name:"detail",label:e._({id:"Tol4BF"}),icon:a.jsx(Ae,{}),content:j},{name:"line-items",label:e._({id:"SgduFH"}),icon:a.jsx(Ie,{}),content:a.jsxs(R,{multiple:!0,defaultValue:["line-items","extra-items"],children:[a.jsxs(R.Item,{value:"line-items",children:[a.jsx(R.Control,{children:a.jsx(se,{size:"lg",children:e._({id:"SgduFH"})})}),a.jsx(R.Panel,{children:a.jsx(dt,{orderId:t.pk,currency:k,customerId:t.customer,editable:t.status!=n.COMPLETE&&t.status!=n.CANCELLED})})]},"lineitems"),a.jsxs(R.Item,{value:"extra-items",children:[a.jsx(R.Control,{children:a.jsx(se,{size:"lg",children:e._({id:"l11DG/"})})}),a.jsx(R.Panel,{children:a.jsx(at,{endpoint:o.sales_order_extra_line_list,orderId:t.pk,currency:k,role:r.sales_order})})]},"extraitems")]})},{name:"shipments",label:e._({id:"aljM0q"}),icon:a.jsx(de,{}),content:a.jsx(ct,{orderId:t.pk})},{name:"allocations",label:e._({id:"MD2yP5"}),icon:a.jsx(Re,{}),content:a.jsx(xe,{orderId:t.pk,showPartInfo:!0,allowEdit:!0,modelField:"item",modelTarget:d.stockitem})},{name:"build-orders",label:e._({id:"RCVhIP"}),icon:a.jsx(re,{}),hidden:!m.hasViewRole(r.build),content:t!=null&&t.pk?a.jsx(st,{salesOrderId:t.pk}):a.jsx(te,{})},Ke({model_type:d.salesorder,model_id:t.pk}),Le({model_type:d.salesorder,model_id:t.pk})],[t,p,m,n,m]),C=x({url:w(o.sales_order_issue,t.pk),title:e._({id:"Zk75Wf"}),onFormSuccess:i,preFormWarning:e._({id:"lLiNZC"}),successMessage:e._({id:"R/WvFK"})}),A=x({url:w(o.sales_order_cancel,t.pk),title:e._({id:"GYdhXE"}),onFormSuccess:i,preFormWarning:e._({id:"MPFqR0"}),successMessage:e._({id:"H5qWhm"})}),h=x({url:w(o.sales_order_hold,t.pk),title:e._({id:"Pgi6wT"}),onFormSuccess:i,preFormWarning:e._({id:"3Wfk51"}),successMessage:e._({id:"0NH/ob"})}),y=x({url:w(o.sales_order_complete,t.pk),title:e._({id:"tMUAZW"}),onFormSuccess:i,preFormWarning:e._({id:"huukBM"}),successMessage:e._({id:"NloAZ8"}),fields:{accept_incomplete:{}}}),N=x({url:w(o.sales_order_complete,t.pk),title:e._({id:"O1h5Uc"}),onFormSuccess:i,preFormWarning:e._({id:"DYITap"}),successMessage:e._({id:"W7TghJ"}),fields:{accept_incomplete:{}}}),q=c.useMemo(()=>{const u=m.hasChangeRole(r.sales_order),v=u&&(t.status==n.PENDING||t.status==n.ON_HOLD),O=u&&(t.status==n.PENDING||t.status==n.ON_HOLD||t.status==n.IN_PROGRESS),I=u&&(t.status==n.PENDING||t.status==n.IN_PROGRESS),P=u&&t.status==n.IN_PROGRESS,z=u&&t.status==n.SHIPPED;return[a.jsx(Z,{title:e._({id:"WajCDs"}),icon:"issue",hidden:!v,color:"blue",onClick:C.open}),a.jsx(Z,{title:e._({id:"7I7mfp"}),icon:"deliver",hidden:!P,color:"blue",onClick:y.open}),a.jsx(Z,{title:e._({id:"NPZqBL"}),icon:"complete",hidden:!z,color:"green",onClick:N.open}),a.jsx(Fe,{model:d.salesorder,id:t.pk}),a.jsx(Ne,{model:d.salesorder,pk:t.pk,hash:t==null?void 0:t.barcode_hash}),a.jsx(Ee,{modelType:d.salesorder,items:[t.pk],enableReports:!0}),a.jsx(qe,{tooltip:e._({id:"/IKytX"}),actions:[Be({hidden:!u,onClick:b.open,tooltip:e._({id:"mVeaUg"})}),Ge({hidden:!m.hasAddRole(r.sales_order),onClick:S.open,tooltip:e._({id:"oi/3Pq"})}),We({tooltip:e._({id:"20mLBC"}),hidden:!I,onClick:h.open}),He({tooltip:e._({id:"tVJk4q"}),hidden:!O,onClick:A.open})]})]},[m,t,n]),U=c.useMemo(()=>_.isLoading?[]:[a.jsx(Ze,{status:t.status_custom_key,type:d.salesorder,options:{size:"lg"}},t.pk)],[t,_]);return a.jsxs(a.Fragment,{children:[C.modal,A.modal,h.modal,y.modal,N.modal,b.modal,S.modal,a.jsx(Te,{status:l,loading:_.isFetching,requiredRole:r.sales_order,children:a.jsxs(we,{gap:"xs",children:[a.jsx(ze,{title:`${e._({id:"LozYBo"})}: ${t.reference}`,subtitle:t.description,imageUrl:(T=t.customer_detail)==null?void 0:T.image,badges:U,actions:q,breadcrumbs:[{name:e._({id:"mUv9U4"}),url:"/sales/"}],editAction:b.open,editEnabled:m.hasChangePermission(d.salesorder)}),a.jsx(Ve,{pageKey:"salesorder",panels:M,model:d.salesorder,id:t.pk,instance:t})]})})]})}export{$t as default};
