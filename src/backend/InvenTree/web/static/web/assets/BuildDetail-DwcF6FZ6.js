import{bA as K,r as d,i as t,j as e,G as $,bC as xe,by as ke,bz as je,aB as ge,m as D,bG as Ce,d as ye,I as Ie,aD as Ae,ce as Oe,cp as Se,bE as ne,bB as Be,J as Fe,ci as z,cT as Y,Z as De,ep as Pe,b3 as we,bq as Te,ad as Ee,eq as qe,bk as ve,en as Re,S as Me}from"./vendor-BnaqX2_l.js";import{A as Le}from"./AdminButton-GD-Bfrm9.js";import{P as re}from"./PrimaryActionButton-DmbHLQKT.js";import{u as ue,I as pe,h as Ne,R as ze,P as Ge}from"./InvenTreeTable-rEa-i3pt.js";import{I as Ue,D as V,a as We}from"./InstanceDetail-DvLVYRQt.js";import{D as Ze,N as He}from"./NotesPanel-Dh1SrbjV.js";import{B as Ve,O as Ye,E as Je,a as Ke,H as Xe,C as Qe}from"./ActionDropdown-D1A3arjv.js";import{P as $e}from"./PageDetail-Ct_zKLxm.js";import{A as et}from"./AttachmentPanel-Ct80LGG4.js";import{P as tt}from"./PanelGroup-CKTRVRga.js";import{d as st,S as at}from"./Instance-DrUTN1gu.js";import{a as ee,e as g,A as b,d as X,U as q,m as c,f as it}from"./index-fPzgLVil.js";import{b as ot,c as lt,d as nt,e as rt,B as dt,u as ct}from"./BuildOrderTable-CYnZPUJ-.js";import{u as P,a as me,c as J,A as ut}from"./UseForm-DwZIxEnj.js";import{u as pt}from"./UseInstance-DbDyyJjp.js";import{u as mt}from"./UseStatusCodes-CE5Vxrbg.js";import{B as _t}from"./BuildAllocatedStockTable-LHqg9kJJ.js";import{a as _e}from"./BuildLineTable-oDbUFRKQ.js";import{P as bt}from"./YesNoButton-W51do83Q.js";import{f as ht}from"./formatters-DBeaC9UC.js";import{d as ft,e as xt,S as de}from"./StockItemTable-Blig3z9s.js";import{f as Q,h as be,a as he,S as kt,P as ce}from"./ColumnRenderers-6jyK6a0i.js";import{d as jt,I as F,S as gt,C as Ct}from"./BaseContext-CH9A7-TB.js";import"./DesktopAppView-CAvOv5f4.js";import"./navigation-B-mN4luC.js";import"./dayjs.min-DlCiWWGX.js";import"./GenericErrorPage-BDqvbBMU.js";import"./NotFound-Dr2EC1Qm.js";import"./PermissionDenied-BHX44oqK.js";import"./PageTitle-AnZP781e.js";import"./AttachmentLink-BJMgqQK8.js";import"./ApiIcon-Bqf-O7I2.js";import"./RemoteComponent-Who-27QQ.js";import"./RemoveRowButton-Dm_wD7jw.js";import"./UseGenerator-DOw_SLei.js";import"./UsePlaceholder-Dc_Ugorx.js";import"./UseFilter-qbbXWiSh.js";import"./OrderPartsWizard-BFgDSSVd.js";import"./CompanyForms-yUzzFM8E.js";import"./PurchaseOrderForms-DPVzsVCo.js";import"./RowExpansionIcon-qojre285.js";function yt({buildId:i,partId:n}){const l=ue("build-tests"),s=ee(),{data:o}=K({queryKey:["build-test-templates",n,i],queryFn:async()=>n?X.get(g(b.part_test_template_list),{params:{part:n,include_inherited:!0,enabled:!0,required:!0}}).then(r=>r.data).catch(r=>[]):[]});d.useEffect(()=>{l.refreshTable()},[o]);const[h,x]=d.useState(0),[u,w]=d.useState(0),p=ft({partId:n,itemId:h,templateId:u}),O=P({url:g(b.stock_test_result_list),title:t._({id:"VzkBcq"}),fields:p,initialData:{template:u,result:!0},onFormSuccess:()=>l.refreshTable(),successMessage:t._({id:"VivtT0"})}),k=d.useMemo(()=>!o||o.length==0?[]:o.map(r=>({accessor:`test_${r.pk}`,title:r.test_name,sortable:!1,switchable:!0,render:f=>{const m=(f.tests||[]).filter(y=>y.template==r.pk).sort((y,S)=>S.pk-y.pk).shift();if(!m||m.result===void 0)return e.jsxs($,{gap:"xs",wrap:"nowrap",justify:"space-between",children:[e.jsx(xe,{color:"lightblue",variant:"filled",children:t._({id:"4bobEy"})}),e.jsx(ke,{label:t._({id:"VzkBcq"}),children:e.jsx(je,{size:"xs",color:"green",variant:"transparent",onClick:()=>{x(f.pk),w(r.pk),O.open()},children:e.jsx(ge,{})})})]});const _=[];return m.value&&_.push(e.jsxs(D,{size:"sm",children:[t._({id:"wMHvYH"}),": ",m.value]},"value")),m.notes&&_.push(e.jsxs(D,{size:"sm",children:[t._({id:"1DBGsz"}),": ",m.notes]},"notes")),m.date&&_.push(e.jsxs(D,{size:"sm",children:[t._({id:"mYGY3B"}),": ",ht(m.date)]},"date")),m.user_detail&&_.push(e.jsx(st,{instance:m.user_detail},"user")),e.jsx(Q,{value:e.jsx(bt,{value:m.result}),title:r.test_name,extra:_})}})),[o]),v=d.useMemo(()=>[...[{accessor:"stock",title:t._({id:"gILim+"}),sortable:!0,switchable:!1,render:f=>{if(f.serial)return`# ${f.serial}`;{const C=[];return f.batch&&C.push(e.jsxs(D,{size:"sm",children:[t._({id:"Vea6Aj"}),": ",f.batch]},"batch")),e.jsx(Q,{value:e.jsxs(D,{children:[t._({id:"VbWX2u"}),": ",f.quantity]}),title:t._({id:"gILim+"}),extra:C})}}},be({accessor:"location_detail"})],...k],[k]),R=d.useMemo(()=>[{name:"is_building",label:t._({id:"BE5Q6v"}),description:t._({id:"AO8gAN"})}],[]),T=d.useMemo(()=>[],[]),j=d.useCallback(r=>[],[s]);return e.jsxs(e.Fragment,{children:[O.modal,e.jsx(pe,{url:g(b.stock_item_list),tableState:l,columns:v,props:{params:{part_detail:!0,location_detail:!0,tests:!0,build:i},rowActions:j,tableFilters:R,tableActions:T}})]})}function It({build:i,output:n,opened:l,close:s}){return e.jsxs(Se,{position:"bottom",size:"lg",title:e.jsxs($,{p:"md",wrap:"nowrap",justify:"space-apart",children:[e.jsx(gt,{size:"lg",children:t._({id:"XqhL5S"})}),e.jsx(ne,{h:"lg"}),e.jsx(he,{part:i.part_detail}),(n==null?void 0:n.serial)&&e.jsxs(D,{size:"sm",children:[t._({id:"AXeJt4"}),": ",n.serial]}),(n==null?void 0:n.batch)&&e.jsxs(D,{size:"sm",children:[t._({id:"Vea6Aj"}),": ",n.batch]}),e.jsx(ne,{h:"lg"})]}),opened:l,onClose:s,withCloseButton:!0,closeOnEscape:!0,closeOnClickOutside:!0,styles:{header:{width:"100%"},title:{width:"100%"}},children:[e.jsx(Be,{}),e.jsx(Fe,{p:"md",children:e.jsx(_e,{build:i,output:n,params:{tracked:!0}})})]})}function At({build:i,refreshBuild:n}){var se,ae,ie;const l=ee(),s=jt(),o=ue("build-outputs"),h=d.useMemo(()=>i.pk??-1,[i.pk]),x=d.useMemo(()=>i.part??-1,[i.part]),{data:u}=K({queryKey:["buildoutputtests",x,i],queryFn:async()=>{var a;return!x||x<0?[]:(a=i==null?void 0:i.part_detail)!=null&&a.testable?X.get(g(b.part_test_template_list),{params:{part:x,include_inherited:!0,enabled:!0,required:!0}}).then(I=>I.data).catch(()=>[]):[]}}),w=d.useMemo(()=>((u==null?void 0:u.length)??0)>0,[x,u]),{data:p,refetch:O}=K({queryKey:["trackeditems",h],queryFn:async()=>!h||h<0?[]:X.get(g(b.build_line_list),{params:{build:h,tracked:!0}}).then(a=>a.data).catch(()=>[])}),k=d.useMemo(()=>((p==null?void 0:p.length)??0)>0,[p]);d.useEffect(()=>{o.refreshTable()},[u,p,k,w]);const v=d.useCallback(a=>(a==null||a.forEach((I,L)=>{const E=[];let oe=0;u==null||u.forEach(B=>{var U;const A=(U=I.tests)==null?void 0:U.filter(N=>N.template==B.pk).sort((N,W)=>N.pk<W.pk?1:-1).shift();B!=null&&B.required&&(A!=null&&A.result)&&(oe+=1),E.push({name:B.test_name,result:(A==null?void 0:A.result)??!1})}),a[L].passCount=oe,a[L].results=E;let le=0;p==null||p.forEach(B=>{var U,N;let A=0;(N=(U=B.allocations)==null?void 0:U.filter(W=>W.install_into==I.pk))==null||N.forEach(W=>{A+=W.quantity}),A>=B.bom_item_detail.quantity&&(le+=1)}),a[L].fullyAllocated=le}),a),[x,h,u,p]),R=ot({build:i}),T=P({url:g(b.build_output_create,h),title:t._({id:"jgrPxc"}),fields:R,timeout:1e4,initialData:{batch_code:i.batch,location:i.destination??((se=i.part_detail)==null?void 0:se.default_location)},table:o}),[j,r]=d.useState([]),f=lt({build:i,outputs:j,onFormSuccess:()=>{o.refreshTable(),n()}}),C=nt({build:i,outputs:j,onFormSuccess:()=>{o.refreshTable(),n()}}),m=rt({build:i,outputs:j,onFormSuccess:()=>{o.refreshTable(),n()}}),_=xt({create:!1,partId:x,stockItem:j[0]}),y=me({url:b.stock_item_list,pk:(ae=j[0])==null?void 0:ae.pk,title:t._({id:"yP367G"}),fields:_,table:o}),S=P({url:b.build_order_deallocate,pk:i.pk,title:t._({id:"ZZL0Jx"}),preFormContent:e.jsx(Ce,{color:"yellow",icon:e.jsx(ye,{}),title:t._({id:"ZZL0Jx"}),children:t._({id:"1s7aZ2"})}),fields:{output:{hidden:!0}},initialData:{output:(ie=j[0])==null?void 0:ie.pk},onFormSuccess:()=>{O()}}),G=d.useMemo(()=>[e.jsx(J,{tooltip:t._({id:"jNuqfk"}),icon:e.jsx(F,{icon:"success"}),color:"green",disabled:!o.hasSelectedRecords,onClick:()=>{r(o.selectedRecords),f.open()}},"complete-selected-outputs"),e.jsx(J,{tooltip:t._({id:"ps+JBt"}),icon:e.jsx(F,{icon:"delete"}),color:"red",disabled:!o.hasSelectedRecords,onClick:()=>{r(o.selectedRecords),C.open()}},"scrap-selected-outputs"),e.jsx(J,{tooltip:t._({id:"MXiIO4"}),icon:e.jsx(F,{icon:"cancel"}),color:"red",disabled:!o.hasSelectedRecords,onClick:()=>{r(o.selectedRecords),m.open()}},"cancel-selected-outputs"),e.jsx(ut,{tooltip:t._({id:"jgrPxc"}),hidden:!l.hasAddRole(q.build),onClick:T.open},"add-build-output")],[l,o.selectedRecords,o.hasSelectedRecords]),M=d.useCallback(a=>[Ne({title:t._({id:"MeORpZ"}),modelId:a.pk,modelType:c.stockitem,navigate:s}),{title:t._({id:"9X8lAk"}),tooltip:t._({id:"kHgU4C"}),color:"blue",hidden:!k||!l.hasChangeRole(q.build),icon:e.jsx(F,{icon:"plus"}),onClick:()=>{r([a]),te()}},{title:t._({id:"kp5oT9"}),tooltip:t._({id:"NLp8ve"}),color:"red",hidden:!k||!l.hasChangeRole(q.build),icon:e.jsx(F,{icon:"minus"}),onClick:()=>{r([a]),S.open()}},{title:t._({id:"bD8I7O"}),tooltip:t._({id:"BdMeIY"}),color:"green",icon:e.jsx(F,{icon:"success"}),onClick:()=>{r([a]),f.open()}},ze({tooltip:t._({id:"yP367G"}),onClick:()=>{r([a]),y.open()}}),{title:t._({id:"5mspUE"}),tooltip:t._({id:"oise/z"}),icon:e.jsx(F,{icon:"delete"}),color:"red",onClick:()=>{r([a]),C.open()}},{title:t._({id:"dEgA5A"}),tooltip:t._({id:"ewDpt2"}),icon:e.jsx(F,{icon:"cancel"}),color:"red",onClick:()=>{r([a]),m.open()}}],[l,x,k]),Z=d.useMemo(()=>[{accessor:"part",sortable:!0,render:a=>he({part:a==null?void 0:a.part_detail})},{accessor:"quantity",ordering:"stock",sortable:!0,switchable:!1,title:t._({id:"gILim+"}),render:a=>{let I=a.quantity;return a.serial&&(I=`# ${a.serial}`),I}},{accessor:"batch",sortable:!0},kt({accessor:"status",sortable:!0,model:c.stockitem}),be({accessor:"location_detail"}),{accessor:"allocations",sortable:!1,switchable:!1,hidden:!k,title:t._({id:"/b62hy"}),render:a=>e.jsx(ce,{progressLabel:!0,value:a.fullyAllocated??0,maximum:(p==null?void 0:p.length)??0})},{accessor:"tests",sortable:!1,switchable:!1,title:t._({id:"E4lFEY"}),hidden:!w,render:a=>{var L;const I=((L=a.results)==null?void 0:L.map(E=>E&&e.jsxs($,{justify:"left",wrap:"nowrap",children:[E.result?e.jsx(Ie,{color:"green"}):e.jsx(Ae,{color:"red"}),e.jsx(D,{children:E.name})]},E.name)))??[];return e.jsx(Q,{value:e.jsx(ce,{progressLabel:!0,value:a.passCount??0,maximum:(u==null?void 0:u.length)??0}),extra:I,title:t._({id:"isbwWo"})})}}],[h,x,w,k,u,p]),[H,{open:te,close:fe}]=Oe(!1);return e.jsxs(e.Fragment,{children:[T.modal,f.modal,C.modal,y.modal,S.modal,m.modal,e.jsx(It,{build:i,output:j[0],opened:H,close:fe}),e.jsx(pe,{tableState:o,url:g(b.stock_item_list),columns:Z,props:{params:{part_detail:!0,tests:!0,is_building:!0,build:h},enableLabels:!0,enableReports:!0,dataFormatter:v,tableActions:G,rowActions:M,enableSelection:!0,onRowClick:a=>{k&&a.serial&&(r([a]),te())}}})]})}function ms(){var C,m;const{id:i}=Ct(),n=ee(),l=mt({modelType:c.build}),{instance:s,refreshInstance:o,instanceQuery:h,requestStatus:x}=pt({endpoint:b.build_order_list,pk:i,params:{part_detail:!0},refetchOnMount:!0}),u=d.useMemo(()=>{var M,Z,H;if(h.isFetching)return e.jsx(z,{});const _=[{type:"link",name:"part",label:t._({id:"vgP+9p"}),model:c.part},{type:"text",name:"part_detail.IPN",icon:"part",label:t._({id:"3wXEsN"}),hidden:!((M=s.part_detail)!=null&&M.IPN),copy:!0},{type:"status",name:"status",label:t._({id:"uAQUqI"}),model:c.build},{type:"status",name:"status_custom_key",label:t._({id:"4DvUAJ"}),model:c.build,icon:"status",hidden:!s.status_custom_key||s.status_custom_key==s.status},{type:"text",name:"reference",label:t._({id:"N2C89m"}),copy:!0},{type:"text",name:"title",label:t._({id:"Nu4oKW"}),icon:"description",copy:!0},{type:"link",name:"parent",icon:"builds",label:t._({id:"jqsG41"}),model_field:"reference",model:c.build,hidden:!s.parent}],y=[{type:"text",name:"quantity",label:t._({id:"Ee+3kG"})},{type:"progressbar",name:"completed",icon:"progress",total:s.quantity,progress:s.completed,label:t._({id:"Mzv4va"})},{type:"link",name:"sales_order",label:t._({id:"LozYBo"}),icon:"sales_orders",model:c.salesorder,model_field:"reference",hidden:!s.sales_order}],S=[{type:"text",name:"issued_by",label:t._({id:"kmUN8p"}),icon:"user",badge:"user"},{type:"text",name:"responsible",label:t._({id:"XQACoK"}),badge:"owner",hidden:!s.responsible},{type:"text",name:"creation_date",label:t._({id:"d+F6q9"}),icon:"calendar",hidden:!s.creation_date},{type:"text",name:"target_date",label:t._({id:"ZmykKo"}),icon:"calendar",hidden:!s.target_date},{type:"text",name:"completion_date",label:t._({id:"qqWcBV"}),icon:"calendar",hidden:!s.completion_date},{type:"text",name:"project_code_label",label:t._({id:"Sdfr6G"}),icon:"reference",copy:!0,hidden:!s.project_code}],G=[{type:"link",name:"take_from",icon:"location",model:c.stocklocation,label:t._({id:"/00Ond"}),backup_value:t._({id:"aZD9Yv"})},{type:"link",name:"destination",icon:"location",model:c.stocklocation,label:t._({id:"o35LCI"}),hidden:!s.destination},{type:"text",name:"batch",label:t._({id:"Vea6Aj"}),hidden:!s.batch,copy:!0}];return e.jsxs(Ue,{children:[e.jsxs(Y,{children:[e.jsx(Y.Col,{span:4,children:e.jsx(Ze,{appRole:q.part,apiPath:b.part_list,src:((Z=s.part_detail)==null?void 0:Z.image)??((H=s.part_detail)==null?void 0:H.thumbnail),pk:s.part})}),e.jsx(Y.Col,{span:8,children:e.jsx(V,{fields:_,item:s})})]}),e.jsx(V,{fields:y,item:s}),e.jsx(V,{fields:S,item:s}),e.jsx(V,{fields:G,item:s})]})},[s,h]),w=d.useMemo(()=>{var _;return[{name:"details",label:t._({id:"98Q4bz"}),icon:e.jsx(De,{}),content:u},{name:"line-items",label:t._({id:"SgduFH"}),icon:e.jsx(Pe,{}),content:s!=null&&s.pk?e.jsx(_e,{build:s}):e.jsx(z,{})},{name:"incomplete-outputs",label:t._({id:"E9en8O"}),icon:e.jsx(we,{}),content:s.pk?e.jsx(At,{build:s,refreshBuild:o}):e.jsx(z,{}),hidden:s.status==l.COMPLETE||s.status==l.CANCELLED},{name:"complete-outputs",label:t._({id:"Mzv4va"}),icon:e.jsx(Te,{}),content:e.jsx(de,{allowAdd:!1,tableName:"build-outputs",params:{build:i,is_building:!1}})},{name:"allocated-stock",label:t._({id:"MD2yP5"}),icon:e.jsx(Ee,{}),hidden:s.status==l.COMPLETE||s.status==l.CANCELLED,content:s.pk?e.jsx(_t,{buildId:s.pk,showPartInfo:!0,allowEdit:!0}):e.jsx(z,{})},{name:"consumed-stock",label:t._({id:"US3GCq"}),icon:e.jsx(qe,{}),content:e.jsx(de,{allowAdd:!1,tableName:"build-consumed",showLocation:!1,params:{consumed_by:i}})},{name:"child-orders",label:t._({id:"CVlgqS"}),icon:e.jsx(ve,{}),content:s.pk?e.jsx(dt,{parentBuildId:s.pk}):e.jsx(z,{})},{name:"test-results",label:t._({id:"isbwWo"}),icon:e.jsx(Re,{}),hidden:!((_=s.part_detail)!=null&&_.testable),content:s.pk?e.jsx(yt,{buildId:s.pk,partId:s.part}):e.jsx(z,{})},et({model_type:c.build,model_id:s.pk}),He({model_type:c.build,model_id:s.pk})]},[s,i,n,l]),p=ct({create:!1}),O=me({url:b.build_order_list,pk:s.pk,title:t._({id:"B7ynKf"}),fields:p,onFormSuccess:o}),k=P({url:b.build_order_list,title:t._({id:"59jtLx"}),fields:p,initialData:{...s,reference:void 0},follow:!0,modelType:c.build}),v=P({url:g(b.build_order_cancel,s.pk),title:t._({id:"MTYJu1"}),onFormSuccess:o,successMessage:t._({id:"H5qWhm"}),preFormWarning:t._({id:"MPFqR0"}),fields:{remove_allocated_stock:{},remove_incomplete_outputs:{}}}),R=P({url:g(b.build_order_hold,s.pk),title:t._({id:"hZIvSn"}),onFormSuccess:o,preFormWarning:t._({id:"3Wfk51"}),successMessage:t._({id:"0NH/ob"})}),T=P({url:g(b.build_order_issue,s.pk),title:t._({id:"Z4Rl+B"}),onFormSuccess:o,preFormWarning:t._({id:"lLiNZC"}),successMessage:t._({id:"R/WvFK"})}),j=P({url:g(b.build_order_complete,s.pk),title:t._({id:"Q/TP3B"}),onFormSuccess:o,preFormWarning:t._({id:"DYITap"}),successMessage:t._({id:"W7TghJ"}),fields:{accept_overallocated:{},accept_unallocated:{},accept_incomplete:{}}}),r=d.useMemo(()=>{const _=n.hasChangeRole(q.build),y=_&&(s.status==l.PENDING||s.status==l.ON_HOLD),S=_&&s.status==l.PRODUCTION,G=_&&(s.status==l.PENDING||s.status==l.PRODUCTION),M=_&&(s.status==l.PENDING||s.status==l.ON_HOLD||s.status==l.PRODUCTION);return[e.jsx(re,{title:t._({id:"WajCDs"}),icon:"issue",hidden:!y,color:"blue",onClick:T.open}),e.jsx(re,{title:t._({id:"NPZqBL"}),icon:"complete",hidden:!S,color:"green",onClick:j.open}),e.jsx(Le,{model:c.build,id:s.pk}),e.jsx(Ve,{model:c.build,pk:s.pk,hash:s==null?void 0:s.barcode_hash}),e.jsx(Ge,{modelType:c.build,items:[s.pk],enableReports:!0}),e.jsx(Ye,{tooltip:t._({id:"tDgG1Y"}),actions:[Je({onClick:()=>O.open(),hidden:!_,tooltip:t._({id:"mVeaUg"})}),Ke({onClick:()=>k.open(),tooltip:t._({id:"oi/3Pq"}),hidden:!n.hasAddRole(q.build)}),Xe({tooltip:t._({id:"20mLBC"}),hidden:!G,onClick:R.open}),Qe({tooltip:t._({id:"tVJk4q"}),onClick:v.open,hidden:!M})]})]},[i,s,n,l]),f=d.useMemo(()=>h.isFetching?[]:[e.jsx(at,{status:s.status_custom_key,type:c.build,options:{size:"lg"}})],[s,h]);return e.jsxs(e.Fragment,{children:[O.modal,k.modal,v.modal,R.modal,T.modal,j.modal,e.jsx(We,{status:x,loading:h.isFetching,requiredRole:q.build,children:e.jsxs(Me,{gap:"xs",children:[e.jsx($e,{title:`${t._({id:"YxwWvi"})}: ${s.reference}`,subtitle:s.title,badges:f,editAction:O.open,editEnabled:n.hasChangePermission(c.part),imageUrl:((C=s.part_detail)==null?void 0:C.image)??((m=s.part_detail)==null?void 0:m.thumbnail),breadcrumbs:[{name:t._({id:"3ctapx"}),url:"/manufacturing"},{name:s.reference,url:it(c.build,s.pk)}],actions:r}),e.jsx(tt,{pageKey:"build",panels:w,instance:s,model:c.build,id:s.pk})]})})]})}export{ms as default};
