import{r as o,j as a,ad as T,bk as q,am as M,aU as R,b1 as A,b4 as O,b5 as D,i as t,S as E,bD as f}from"./vendor-BnaqX2_l.js";import{u as y,S as j,g as L,A as P}from"./UseForm-DwZIxEnj.js";import{a as g,P as C,R as U,S as B,c as w,C as I,T as V,i as Q,e as N}from"./ColumnRenderers-6jyK6a0i.js";import{S as H,d as W}from"./Instance-DrUTN1gu.js";import{l as G,e as k,A as x,m as b,a as X,U as z}from"./index-fPzgLVil.js";import{R as v}from"./RemoveRowButton-Dm_wD7jw.js";import{u as $}from"./UseGenerator-DOw_SLei.js";import{u as K}from"./UsePlaceholder-Dc_Ugorx.js";import{u as J,a as Y}from"./UseFilter-qbbXWiSh.js";import{u as Z,S as ee,b as te,A as ae,M as se,c as ie,C as re,d as oe,T as le,e as ne,f as ue,g as de,H as ce,I as me}from"./InvenTreeTable-rEa-i3pt.js";function _e({create:e}){const[s,r]=o.useState(null),[l,u]=o.useState(""),d=$(c=>{l||u(c)}),i=G();return o.useMemo(()=>{const c={reference:{},part:{disabled:!e,filters:{assembly:!0,virtual:!1,active:i.isSet("BUILDORDER_REQUIRE_ACTIVE_PART")?!0:void 0,locked:i.isSet("BUILDORDER_REQUIRE_LOCKED_PART")?!0:void 0},onValueChange(m,n){n&&r(n.default_location||n.category_default_location),d.update({part:m})}},title:{},quantity:{},project_code:{icon:a.jsx(T,{})},priority:{},parent:{icon:a.jsx(q,{}),filters:{part_detail:!0}},sales_order:{icon:a.jsx(M,{})},batch:{value:l,onValueChange:m=>u(m)},target_date:{icon:a.jsx(R,{})},take_from:{},destination:{filters:{structural:!1},value:s},link:{icon:a.jsx(A,{})},issued_by:{icon:a.jsx(O,{}),filters:{is_active:!0}},responsible:{icon:a.jsx(D,{}),filters:{is_active:!0}}};return e&&(c.create_child_builds={}),c},[e,s,l,i])}function ve({build:e}){var c,m;const s=o.useMemo(()=>{var n;return((n=e.part_detail)==null?void 0:n.trackable)??!1},[e.part_detail]),[r,l]=o.useState(null);o.useEffect(()=>{var n;l(e.location||((n=e.part_detail)==null?void 0:n.default_location)||null)},[e.location,e.part_detail]);const[u,d]=o.useState(0);o.useEffect(()=>{const n=e.quantity??0,_=e.completed??0;d(Math.max(0,n-_))},[e]);const i=K({partId:(c=e.part_detail)==null?void 0:c.pk,key:"build-output",enabled:(m=e.part_detail)==null?void 0:m.trackable});return o.useMemo(()=>({quantity:{value:u,onValueChange:n=>{d(n)}},serial_numbers:{hidden:!s,placeholder:i},batch_code:{},location:{value:r,onValueChange:n=>{d(n)}},auto_allocate:{hidden:!s}}),[u,i,s])}function F({props:e,record:s}){const r=o.useMemo(()=>s.serial?`# ${s.serial}`:`${t._({id:"VbWX2u"})}: ${s.quantity}`,[s]);return a.jsx(a.Fragment,{children:a.jsxs(f.Tr,{children:[a.jsx(f.Td,{children:a.jsx(g,{part:s.part_detail})}),a.jsx(f.Td,{children:a.jsx(L,{props:e,errorKey:"output",children:r})}),a.jsx(f.Td,{children:s.batch}),a.jsxs(f.Td,{children:[a.jsx(H,{status:s.status,type:b.stockitem})," "]}),a.jsx(f.Td,{style:{width:"1%",whiteSpace:"nowrap"},children:a.jsx(v,{onClick:()=>e.removeFn(e.idx)})})]})})}function Se({build:e,outputs:s,onFormSuccess:r}){const[l,u]=o.useState(null);o.useEffect(()=>{var i;l||u(e.destination||((i=e.part_detail)==null?void 0:i.default_location)||null)},[l,e.destination,e.part_detail]);const d=o.useMemo(()=>({outputs:{field_type:"table",value:s.map(i=>({output:i.pk})),modelRenderer:i=>{const c=s.find(m=>m.pk==i.item.output);return a.jsx(F,{props:i,record:c},c.pk)},headers:[t._({id:"vgP+9p"}),t._({id:"gILim+"}),t._({id:"rsx3xA"}),t._({id:"uAQUqI"})]},status_custom_key:{},location:{filters:{structural:!1},value:l,onValueChange:i=>{u(i)}},notes:{},accept_incomplete_allocation:{}}),[l,s]);return y({url:k(x.build_output_complete,e.pk),method:"POST",title:t._({id:"0iR9fu"}),fields:d,onFormSuccess:r,successMessage:t._({id:"N3avUJ"}),size:"80%"})}function Te({build:e,outputs:s,onFormSuccess:r}){const[l,u]=o.useState(null);o.useEffect(()=>{var i;l||u(e.destination||((i=e.part_detail)==null?void 0:i.default_location)||null)},[l,e.destination,e.part_detail]);const d=o.useMemo(()=>({outputs:{field_type:"table",value:s.map(i=>({output:i.pk,quantity:i.quantity})),modelRenderer:i=>{const c=s.find(m=>m.pk==i.item.output);return a.jsx(F,{props:i,record:c},c.pk)},headers:[t._({id:"vgP+9p"}),t._({id:"igx8Og"}),t._({id:"rsx3xA"}),t._({id:"uAQUqI"})]},location:{value:l,onValueChange:i=>{u(i)}},notes:{},discard_allocations:{}}),[l,s]);return y({url:k(x.build_output_scrap,e.pk),method:"POST",title:t._({id:"69qbY/"}),fields:d,onFormSuccess:r,successMessage:t._({id:"C+tSd4"}),size:"80%"})}function qe({build:e,outputs:s,onFormSuccess:r}){const l=o.useMemo(()=>({outputs:{field_type:"table",value:s.map(u=>({output:u.pk})),modelRenderer:u=>{const d=s.find(i=>i.pk==u.item.output);return a.jsx(F,{props:u,record:d},d.pk)},headers:[t._({id:"vgP+9p"}),t._({id:"igx8Og"}),t._({id:"rsx3xA"}),t._({id:"uAQUqI"})]}}),[s]);return y({url:k(x.build_output_delete,e.pk),method:"POST",title:t._({id:"xS5DxW"}),fields:l,onFormSuccess:r,successMessage:t._({id:"cdFWk4"}),size:"80%"})}function pe({props:e,record:s,sourceLocation:r}){var d,i,c,m;const l=o.useMemo(()=>({field_type:"related field",api_url:k(x.stock_item_list),model:b.stockitem,filters:{available:!0,part_detail:!0,location_detail:!0,bom_item:s.bom_item,location:r,cascade:r?!0:void 0},value:e.item.stock_item,name:"stock_item",onValueChange:(n,_)=>{if(e.changeFn(e.idx,"stock_item",n),_){const h=_.quantity-_.allocated;h<e.item.quantity&&e.changeFn(e.idx,"quantity",Math.min(e.item.quantity,h))}}}),[s,e]),u=o.useMemo(()=>({field_type:"number",name:"quantity",required:!0,value:e.item.quantity,onValueChange:n=>{e.changeFn(e.idx,"quantity",n)}}),[e]);return a.jsxs(f.Tr,{children:[a.jsx(f.Td,{children:a.jsx(g,{part:s.part_detail})}),a.jsx(f.Td,{children:a.jsx(C,{value:s.allocatedQuantity,maximum:s.requiredQuantity,progressLabel:!0})}),a.jsx(f.Td,{children:a.jsx(j,{fieldName:"stock_item",fieldDefinition:l,error:(i=(d=e.rowErrors)==null?void 0:d.stock_item)==null?void 0:i.message})}),a.jsx(f.Td,{children:a.jsx(j,{fieldName:"quantity",fieldDefinition:u,error:(m=(c=e.rowErrors)==null?void 0:c.quantity)==null?void 0:m.message})}),a.jsx(f.Td,{children:a.jsx(v,{onClick:()=>e.removeFn(e.idx)})})]},`table-row-${s.pk}`)}function Me({buildId:e,outputId:s,build:r,lineItems:l,onFormSuccess:u}){const[d,i]=o.useState(void 0),c=o.useMemo(()=>({items:{field_type:"table",value:[],headers:[t._({id:"vgP+9p"}),t._({id:"A/ybx7"}),t._({id:"igx8Og"}),t._({id:"VbWX2u"})],modelRenderer:h=>{const p=l.find(S=>S.pk==h.item.build_line)??{};return a.jsx(pe,{props:h,record:p,sourceLocation:d},h.idx)}}}),[l,d]);o.useEffect(()=>{i(r==null?void 0:r.take_from)},[r==null?void 0:r.take_from]);const m=o.useMemo(()=>({field_type:"related field",api_url:k(x.stock_location_list),model:b.stocklocation,required:!1,label:t._({id:"/00Ond"}),description:t._({id:"IArqwk"}),name:"source_location",value:r==null?void 0:r.take_from,onValueChange:_=>{i(_)}}),[r==null?void 0:r.take_from]),n=o.useMemo(()=>a.jsx(E,{gap:"xs",children:a.jsx(j,{fieldDefinition:m})}),[m]);return y({url:x.build_order_allocate,pk:e,title:t._({id:"L1LMmH"}),fields:c,preFormContent:n,successMessage:t._({id:"23SrHL"}),onFormSuccess:u,initialData:{items:l.map(_=>({build_line:_.pk,stock_item:void 0,quantity:Math.max(0,_.requiredQuantity-_.allocatedQuantity),output:s}))},size:"80%"})}function Re({partId:e,parentBuildId:s,salesOrderId:r}){const l=Z(e?"buildorder-part":"buildorder-index"),u=o.useMemo(()=>[U({}),{accessor:"part",sortable:!0,switchable:!1,render:p=>g({part:p.part_detail})},{accessor:"part_detail.IPN",sortable:!0,switchable:!0,title:t._({id:"3wXEsN"})},{accessor:"title",sortable:!1},{accessor:"completed",sortable:!0,switchable:!1,render:p=>a.jsx(C,{progressLabel:!0,value:p.completed,maximum:p.quantity})},B({model:b.build}),w({}),{accessor:"level",sortable:!0,switchable:!0,hidden:!s},{accessor:"priority",sortable:!0},I({}),V({}),Q({accessor:"completion_date",title:t._({id:"41ha49"}),sortable:!0}),{accessor:"issued_by",sortable:!0,render:p=>a.jsx(W,{instance:p==null?void 0:p.issued_by_detail})},N({})],[s]),d=J(),i=Y(),c=o.useMemo(()=>{const p=[{name:"outstanding",type:"boolean",label:t._({id:"aimnwe"}),description:t._({id:"hUps7c"})},{name:"status",label:t._({id:"uAQUqI"}),description:t._({id:"OIH7WF"}),choiceFunction:ee(b.build)},te(),ae(),se(),ie(),re(),oe(),le(),ne(),ue(),de(),{name:"project_code",label:t._({id:"Sdfr6G"}),description:t._({id:"8sHFLc"}),choices:d.choices},ce(),{name:"issued_by",label:t._({id:"kmUN8p"}),description:t._({id:"OEh/FL"}),choices:i.choices},{name:"assigned_to",label:t._({id:"XQACoK"}),description:t._({id:"OVVPn5"}),choices:i.choices}];return e&&p.push({name:"include_variants",type:"boolean",label:t._({id:"/g9i/Z"}),description:t._({id:"NkXwQy"})}),p},[e,d.choices,i.choices]),m=X(),n=_e({create:!0}),_=y({url:x.build_order_list,title:t._({id:"59jtLx"}),fields:n,initialData:{part:e,sales_order:r,parent:s},follow:!0,modelType:b.build}),h=o.useMemo(()=>[a.jsx(P,{hidden:!m.hasAddRole(z.build),tooltip:t._({id:"59jtLx"}),onClick:()=>_.open()},"add-build-order")],[m]);return a.jsxs(a.Fragment,{children:[_.modal,a.jsx(me,{url:k(x.build_order_list),tableState:l,columns:u,props:{params:{part:e,ancestor:s,sales_order:r,part_detail:!0},tableActions:h,tableFilters:c,modelType:b.build,enableSelection:!0,enableReports:!0,enableDownload:!0}})]})}export{Re as B,Me as a,ve as b,Se as c,Te as d,qe as e,_e as u};
