import{r as i,n as O,i as l,j as e,cs as z,G as S,m as _,I as q,ei as U,dZ as v,d as H,S as b,J as G,bE as M,v as E,aM as P,bG as N,bD as j,bO as J,ej as Y,C as $,l as K,L as V,bB as Z,cp as W,bF as X,e1 as I}from"./vendor-BnaqX2_l.js";import{A as g,m as L,d as k,e as y}from"./index-fPzgLVil.js";import{u as ee}from"./UseInstance-DbDyyJjp.js";import{u as Q}from"./UseStatusCodes-CE5Vxrbg.js";import{S as B}from"./BaseContext-CH9A7-TB.js";import{c as se}from"./navigation-B-mN4luC.js";import{a as te,b as re,c as le,S as ie}from"./UseForm-DwZIxEnj.js";import{u as ae,R as ne,a as oe,I as de}from"./InvenTreeTable-rEa-i3pt.js";import{Y as ce}from"./YesNoButton-W51do83Q.js";import{P as ue}from"./ColumnRenderers-6jyK6a0i.js";import{e as pe}from"./Instance-DrUTN1gu.js";function fe({sessionId:t}){const{instance:s,setInstance:a,refreshInstance:n,instanceQuery:o}=ee({endpoint:g.import_session_list,pk:t,defaultValue:{}}),p=i.useCallback(r=>{a(r)},[]),f=Q({modelType:L.importsession}),h=i.useMemo(()=>(s==null?void 0:s.status)??f.INITIAL,[s,f]),c=i.useMemo(()=>(s==null?void 0:s.available_fields)??[],[s]),m=i.useMemo(()=>{let r=(s==null?void 0:s.columns)??[];return r=r.filter(u=>!!u),r=r.filter((u,x)=>r.indexOf(u)===x),r},[s.columns]),T=i.useMemo(()=>{var u;let r=((u=s==null?void 0:s.column_mappings)==null?void 0:u.map(x=>({...x,...c[x.field]??{}})))??[];return r=r.sort((x,C)=>x!=null&&x.required&&!(C!=null&&C.required)?-1:!(x!=null&&x.required)&&(C!=null&&C.required)?1:0),r},[s,m]),F=i.useMemo(()=>{var r;return((r=s==null?void 0:s.column_mappings)==null?void 0:r.filter(u=>!!u.column))??[]},[s]),w=i.useMemo(()=>(s==null?void 0:s.field_defaults)??{},[s]),R=i.useMemo(()=>(s==null?void 0:s.field_overrides)??{},[s]),A=i.useMemo(()=>(s==null?void 0:s.field_filters)??{},[s]),D=i.useMemo(()=>(s==null?void 0:s.row_count)??0,[s]),d=i.useMemo(()=>(s==null?void 0:s.completed_row_count)??0,[s]);return{sessionData:s,setSessionData:p,sessionId:t,refreshSession:n,sessionQuery:o,status:h,availableFields:c,availableColumns:m,columnMappings:T,mappedFields:F,fieldDefaults:w,fieldOverrides:R,fieldFilters:A,rowCount:D,completedRowCount:d}}function xe({session:t,column:s,row:a,onEdit:n}){const o=i.useCallback(c=>{se(c),a.complete||n==null||n()},[n,a]),p=i.useMemo(()=>a.errors?(a==null?void 0:a.errors[s.field])??[]:[],[a.errors,s.field]),f=i.useMemo(()=>{const c=t.availableFields[s.field];if(!(a!=null&&a.data))return"-";switch(c==null?void 0:c.type){case"boolean":return e.jsx(ce,{value:a.data?a.data[s.field]:!1});case"related field":if(c.model&&a.data[s.field])return e.jsx(pe,{model:c.model,pk:a.data[s.field]});break}let m=a.data?a.data[s.field]??"":"";return m||(m="-"),m},[a.data,s.field,t.availableFields]),h=i.useMemo(()=>p.length==0,[p]);return e.jsxs(v,{disabled:h,openDelay:100,closeDelay:100,children:[e.jsx(v.Target,{children:e.jsx(S,{grow:!0,justify:"apart",onClick:o,children:e.jsx(S,{grow:!0,style:{flex:1},children:e.jsx(_,{size:"xs",c:h?void 0:"red",children:f})})})}),e.jsx(v.Dropdown,{children:e.jsx(b,{gap:"xs",children:p.map(c=>e.jsx(_,{size:"xs",c:"red",children:c},c))})})]})}function he({session:t}){const s=ae("dataimporter"),[a,n]=i.useState([]),o=i.useMemo(()=>{const d={};for(const r of a){const u=t.availableFields[r];if(u){let x=u.filters??{};t.fieldFilters[r]&&(x={...x,...t.fieldFilters[r]}),d[r]={...u,field_type:u.type,description:u.help_text,filters:x}}}return d},[a,t.availableFields,t.fieldFilters]),p=i.useCallback(d=>{O.show({title:l._({id:"fawxGh"}),message:l._({id:"SdvoV5"}),autoClose:!1,color:"blue",id:"importing-rows",icon:e.jsx(z,{})}),k.post(y(g.import_session_accept_rows,t.sessionId),{rows:d}).catch(()=>{O.show({title:l._({id:"SlfejT"}),message:l._({id:"aydx5i"}),color:"red",autoClose:!0})}).finally(()=>{s.clearSelectedRecords(),O.hide("importing-rows"),s.refreshTable(),t.refreshSession()})},[t.sessionId,s.refreshTable]),[f,h]=i.useState({}),c=te({url:g.import_session_row_list,pk:f.pk,title:l._({id:"bo3Q/V"}),fields:o,initialData:f.data,fetchInitialData:!1,processFormData:d=>({data:{...f.data,...d}}),onFormSuccess:d=>s.updateRecord(d)}),m=i.useCallback((d,r)=>{h(d),n([r.field]),c.open()},[t,c]),T=re({url:g.import_session_row_list,pk:f.pk,title:l._({id:"f2AJjl"}),onFormSuccess:()=>s.refreshTable()}),F=i.useCallback(d=>{if(!d.errors)return[];const r=[];for(const u of Object.keys(d.errors))d.errors[u]&&(Array.isArray(d.errors[u])?d.errors[u].forEach(x=>{r.push(`${u}: ${x}`)}):r.push(d.errors[u].toString()));return r},[]),w=i.useMemo(()=>[{accessor:"row_index",title:l._({id:"IqKCNQ"}),sortable:!0,switchable:!1,render:r=>e.jsxs(S,{justify:"left",gap:"xs",children:[e.jsx(_,{size:"sm",children:r.row_index}),r.complete&&e.jsx(q,{color:"green",size:16}),!r.complete&&r.valid&&e.jsx(U,{color:"blue",size:16}),!r.complete&&!r.valid&&e.jsxs(v,{openDelay:50,closeDelay:100,children:[e.jsx(v.Target,{children:e.jsx(H,{color:"red",size:16})}),e.jsx(v.Dropdown,{children:e.jsxs(b,{gap:"xs",children:[e.jsxs(_,{children:[l._({id:"H14AdY"}),":"]}),F(r).map(u=>e.jsx(_,{size:"sm",c:"red",children:u},u))]})})]})]})},...t.mappedFields.map(r=>({accessor:r.field,title:r.label??r.column,sortable:!1,switchable:!0,render:u=>e.jsx(xe,{session:t,column:r,row:u,onEdit:()=>m(u,r)})}))],[t]),R=i.useCallback(d=>[{title:l._({id:"g3UF2V"}),icon:e.jsx(z,{}),color:"green",hidden:d.complete||!d.valid,onClick:()=>{p([d.pk])}},ne({hidden:d.complete,onClick:()=>{h(d),n(t.mappedFields.map(r=>r.field)),c.open()}}),oe({onClick:()=>{h(d),T.open()}})],[t,p]),A=i.useMemo(()=>[{name:"valid",label:l._({id:"nfagfM"}),description:l._({id:"p385PV"}),type:"boolean"},{name:"complete",label:l._({id:"bD8I7O"}),description:l._({id:"ytCibL"}),type:"boolean"}],[]),D=i.useMemo(()=>{const d=s.hasSelectedRecords&&s.selectedRecords.every(r=>r.valid&&!r.complete);return[e.jsx(le,{disabled:!d,icon:e.jsx(z,{}),color:"green",tooltip:l._({id:"Fgr3ay"}),onClick:()=>{p(s.selectedRecords.map(r=>r.pk))}},"import-selected-rows")]},[s.hasSelectedRecords,s.selectedRecords]);return e.jsxs(e.Fragment,{children:[c.modal,T.modal,e.jsxs(b,{gap:"xs",children:[e.jsx(G,{shadow:"xs",p:"xs",children:e.jsxs(S,{grow:!0,justify:"apart",children:[e.jsx(_,{size:"lg",children:l._({id:"6dO0jk"})}),e.jsx(M,{}),e.jsx(ue,{maximum:t.rowCount,value:t.completedRowCount,progressLabel:!0}),e.jsx(M,{})]})}),e.jsx(de,{tableState:s,columns:w,url:y(g.import_session_row_list),props:{params:{session:t.sessionId},rowActions:R,tableActions:D,tableFilters:A,enableColumnSwitching:!0,enableColumnCaching:!1,enableSelection:!0,enableBulkDelete:!0,afterBulkDelete:()=>{t.refreshSession()}}})]})]})}function me({column:t,options:s}){const[a,n]=i.useState(""),[o,p]=i.useState(t.column??"");i.useEffect(()=>{p(t.column??"")},[t.column]);const f=i.useCallback(h=>{k.patch(y(g.import_session_column_mapping_list,t.pk),{column:h||""}).then(c=>{var m;p(((m=c.data)==null?void 0:m.column)??h),n("")}).catch(c=>{const m=c.response.data;n(m.column??m.non_field_errors??l._({id:"Vw8l6h"}))})},[t]);return e.jsx(J,{error:a,clearable:!0,searchable:!0,placeholder:l._({id:"TJu1/1"}),label:void 0,data:s,value:o,onChange:f})}function je({fieldName:t,session:s}){const a=i.useCallback(o=>{const p={...s.fieldDefaults,[t]:o};k.patch(y(g.import_session_list,s.sessionId),{field_defaults:p}).then(f=>{s.setSessionData(f.data)}).catch(()=>{})},[t,s,s.fieldDefaults]),n=i.useMemo(()=>{let o=s.availableFields[t];return o&&(o={...o,value:s.fieldDefaults[t],field_type:o.type,description:o.help_text,onValueChange:a}),o},[t,s.availableFields,s.fieldDefaults]);return n&&e.jsx(ie,{fieldDefinition:n,hideLabels:!0})}function _e({session:t,column:s,options:a}){return e.jsxs(j.Tr,{children:[e.jsx(j.Td,{children:e.jsxs(S,{gap:"xs",children:[e.jsx(_,{fw:s.required?700:void 0,children:s.label??s.field}),s.required&&e.jsx(_,{c:"red",fw:700,children:"*"})]})}),e.jsx(j.Td,{children:e.jsx(_,{size:"sm",children:s.description})}),e.jsx(j.Td,{children:e.jsx(me,{column:s,options:a})}),e.jsx(j.Td,{children:e.jsx(je,{fieldName:s.field,session:t})})]},s.label??s.field)}function be({session:t}){const[s,a]=i.useState(""),n=i.useCallback(()=>{const p=y(g.import_session_accept_fields,t.sessionId);k.post(p).then(()=>{t.refreshSession()}).catch(f=>{var h,c;a(((c=(h=f.response)==null?void 0:h.data)==null?void 0:c.error)??l._({id:"Vw8l6h"}))})},[t.sessionId]),o=i.useMemo(()=>[{value:"",label:l._({id:"ojDp4A"})},...t.availableColumns.map(p=>({value:p,label:p}))],[t.availableColumns]);return e.jsxs(b,{gap:"xs",children:[e.jsx(G,{shadow:"xs",p:"xs",children:e.jsxs(S,{grow:!0,justify:"apart",children:[e.jsx(_,{size:"lg",children:l._({id:"AHjxLx"})}),e.jsx(M,{}),e.jsx(E,{color:"green",variant:"filled",onClick:n,children:e.jsxs(S,{children:[e.jsx(P,{}),l._({id:"Y+Sfcf"})]})})]})}),s&&e.jsx(N,{color:"red",title:l._({id:"SlfejT"}),children:e.jsx(_,{children:s})}),e.jsxs(j,{children:[e.jsx(j.Thead,{children:e.jsxs(j.Tr,{children:[e.jsx(j.Th,{children:l._({id:"3mVQ03"})}),e.jsx(j.Th,{children:l._({id:"Us9epU"})}),e.jsx(j.Th,{children:l._({id:"qsUkVg"})}),e.jsx(j.Th,{children:l._({id:"aQ8swY"})})]})}),e.jsx(j.Tbody,{children:t.columnMappings.map(p=>e.jsx(_e,{session:t,column:p,options:o},`import-${p.field}}`))})]})]})}function ge({session:t}){const s=Q({modelType:L.importsession}),a=Y(()=>{t.status==s.IMPORTING&&t.refreshSession()},1e3);return i.useEffect(()=>(a.start(),a.stop),[]),e.jsx($,{children:e.jsx(K,{children:e.jsxs(b,{gap:"xs",children:[e.jsx(B,{size:"lg",children:l._({id:"JT9Hk8"})}),e.jsx(V,{}),e.jsxs(_,{size:"lg",children:[l._({id:"drGZDS"}),": ",t.sessionData.row_count]})]})})})}function Se({currentStep:t}){return e.jsxs(I,{active:t,onStepClick:void 0,allowNextStepsSelect:!1,iconSize:20,size:"xs",children:[e.jsx(I.Step,{label:l._({id:"IQ3gAw"})}),e.jsx(I.Step,{label:l._({id:"KXVPhI"})}),e.jsx(I.Step,{label:l._({id:"FhMhTR"})}),e.jsx(I.Step,{label:l._({id:"eHQfWJ"})}),e.jsx(I.Step,{label:l._({id:"b8ESNU"})})]})}function De({sessionId:t,opened:s,onClose:a}){const n=fe({sessionId:t}),o=Q({modelType:L.importsession}),p=i.useMemo(()=>{switch(n.status){case o.INITIAL:return 0;case o.MAPPING:return 1;case o.IMPORTING:return 2;case o.PROCESSING:return 3;case o.COMPLETE:return 4;default:return 0}},[n.status]),f=i.useMemo(()=>{if(n.sessionQuery.isLoading||n.sessionQuery.isFetching)return e.jsx(V,{});switch(n.status){case o.INITIAL:return e.jsx(_,{children:"Initial : TODO"});case o.MAPPING:return e.jsx(be,{session:n});case o.IMPORTING:return e.jsx(ge,{session:n});case o.PROCESSING:return e.jsx(he,{session:n});case o.COMPLETE:return e.jsxs(b,{gap:"xs",children:[e.jsx(N,{color:"green",title:l._({id:"4fgz8U"}),icon:e.jsx(P,{}),children:l._({id:"zdT9Dy"})}),e.jsx(E,{color:"blue",onClick:a,children:l._({id:"yz7wBu"})})]});default:return e.jsxs(b,{gap:"xs",children:[e.jsxs(N,{color:"red",title:l._({id:"SC1Cur"}),icon:e.jsx(P,{}),children:[l._({id:"+6NHN9"}),": ",n.status]}),e.jsx(E,{color:"red",onClick:a,children:l._({id:"yz7wBu"})})]})}},[n.status,n.sessionQuery]),h=i.useMemo(()=>{var c;return e.jsxs(b,{gap:"xs",style:{width:"100%"},children:[e.jsxs(S,{gap:"xs",wrap:"nowrap",justify:"space-apart",grow:!0,preventGrowOverflow:!1,children:[e.jsx(B,{size:"lg",children:((c=n.sessionData)==null?void 0:c.statusText)??l._({id:"CTRRU5"})}),e.jsx(Se,{currentStep:p}),e.jsx(M,{})]}),e.jsx(Z,{})]})},[n.sessionData]);return e.jsx(W,{position:"bottom",size:"80%",title:h,opened:s,onClose:a,withCloseButton:!0,closeOnEscape:!1,closeOnClickOutside:!1,styles:{header:{width:"100%"},title:{width:"100%"}},children:e.jsxs(b,{gap:"xs",children:[e.jsx(X,{visible:n.sessionQuery.isFetching}),e.jsx(G,{p:"md",children:n.sessionQuery.isFetching||f})]})})}function Oe(){return{data_file:{},model_type:{},field_defaults:{hidden:!0,value:{}},field_overrides:{hidden:!0,value:{}},field_filters:{hidden:!0,value:{}}}}export{De as I,Oe as d};
