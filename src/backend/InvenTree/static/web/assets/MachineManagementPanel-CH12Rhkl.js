import{j as e,cx as te,r as u,G as m,m as x,bC as L,i,cy as V,B as Q,bA as E,n as ie,aM as re,S as b,T as B,ax as K,bI as d,bW as k,bF as N,cq as ne,fd as A,d3 as U,bG as R,d as le,bz as X,Z}from"./vendor-BnaqX2_l.js";import{A as y,e as I,d as q}from"./index-fPzgLVil.js";import{d as S,T as M,S as w}from"./BaseContext-CH9A7-TB.js";import{u as ae,A as de,a as oe,b as ce}from"./UseForm-DwZIxEnj.js";import{Y as J}from"./YesNoButton-W51do83Q.js";import{O as xe,E as ue,D as je}from"./ActionDropdown-D1A3arjv.js";import{I as c}from"./InfoItem-D6fJaMd4.js";import{D as Y,a as D}from"./DetailDrawer-M_KAZNzc.js";import{a as pe,S as he}from"./Instance-DrUTN1gu.js";import{M as H}from"./SettingList-CWkD4zaU.js";import{u as G,I as O}from"./InvenTreeTable-rEa-i3pt.js";import{B as $}from"./ColumnRenderers-6jyK6a0i.js";import"./dayjs.min-DlCiWWGX.js";import"./ApiIcon-Bqf-O7I2.js";import"./DesktopAppView-CAvOv5f4.js";import"./navigation-B-mN4luC.js";import"./formatters-DBeaC9UC.js";function T(){return e.jsx(te,{size:18,color:"red"})}function P({machine:r}){const o={marginLeft:"4px"};if(!r.active)return e.jsx(V,{style:o,color:"gray",children:e.jsx(Q,{})});let l="green";r.machine_errors.length>0||!r.is_driver_available||r.status>=300?l="red":r.status>=200&&(l="orange");const a=r.initialized&&r.status>0&&r.status<300;return e.jsx(V,{processing:a,style:o,color:l,children:e.jsx(Q,{})})}function W({includeTypes:r=!0,includeDrivers:o=!0}={}){const{data:l,isFetching:s,refetch:a}=E({enabled:r,queryKey:["machine-types"],queryFn:()=>q.get(I(y.machine_types_list)).then(j=>j.data),staleTime:1e4}),{data:t,isFetching:h,refetch:f}=E({enabled:o,queryKey:["machine-drivers"],queryFn:()=>q.get(I(y.machine_driver_list)).then(j=>j.data),staleTime:10*1e3}),g=u.useCallback(()=>{a(),f()},[f,a]);return{machineTypes:l,machineDrivers:t,isFetching:s||h,refresh:g}}function _e({machinePk:r,refreshTable:o}){const l=S(),{data:s,refetch:a,isFetching:t}=E({enabled:!0,queryKey:["machine-detail",r],queryFn:()=>q.get(I(y.machine_list,r)).then(F=>F.data)}),{machineTypes:h,machineDrivers:f,isFetching:g}=W(),j=t||g,p=u.useMemo(()=>h&&s?h.find(F=>F.slug===s.machine_type):void 0,[s==null?void 0:s.machine_type,h]),_=u.useMemo(()=>f&&s?f.find(F=>F.slug===s.driver):void 0,[s==null?void 0:s.driver,f]),C=u.useCallback(()=>{a(),o()},[a,o]),n=u.useCallback(F=>{q.post(I(y.machine_restart,void 0,{machine:F})).then(()=>{C(),ie.show({message:i._({id:"8hvWaA"}),color:"green",icon:e.jsx(re,{size:"1rem"})})})},[C]),v=oe({title:i._({id:"RBquff"}),url:y.machine_list,pk:r,fields:u.useMemo(()=>({name:{},active:{}}),[]),onClose:()=>C()}),z=ce({title:i._({id:"5ihjEH"}),successMessage:i._({id:"ZbXCol"}),url:y.machine_list,pk:r,preFormContent:e.jsx(x,{children:i._({id:"Y9eJUJ",values:{0:s==null?void 0:s.name}})}),onFormSuccess:()=>{o(),l(-1)}});return e.jsx(e.Fragment,{children:e.jsxs(b,{gap:"xs",children:[v.modal,z.modal,e.jsxs(m,{justify:"space-between",children:[e.jsxs(m,{children:[s&&e.jsx(P,{machine:s}),e.jsx(B,{order:4,children:s==null?void 0:s.name})]}),e.jsxs(m,{children:[(s==null?void 0:s.restart_required)&&e.jsx(L,{color:"red",children:e.jsx(M,{id:"dKwnjv"})}),e.jsx(xe,{tooltip:i._({id:"72f9dQ"}),actions:[ue({tooltip:i._({id:"RBquff"}),onClick:v.open}),je({tooltip:i._({id:"5ihjEH"}),onClick:z.open}),{icon:e.jsx(K,{}),name:i._({id:"6z9W13"}),tooltip:i._({id:"Plnldt"})+(s!=null&&s.restart_required?` (${i._({id:"kbLjlB"})})`:""),indicator:s!=null&&s.restart_required?{color:"red"}:void 0,onClick:()=>s&&n(s==null?void 0:s.pk)}]})]})]}),e.jsxs(d,{multiple:!0,defaultValue:["machine-info","machine-settings","driver-settings"],children:[e.jsxs(d.Item,{value:"machine-info",children:[e.jsx(d.Control,{children:e.jsx(w,{size:"lg",children:i._({id:"gz3Ont"})})}),e.jsx(d.Panel,{children:e.jsx(k,{withBorder:!0,children:e.jsx(b,{gap:"md",children:e.jsxs(b,{pos:"relative",gap:"xs",children:[e.jsx(N,{visible:j,overlayProps:{opacity:0}}),e.jsx(c,{name:i._({id:"pwL+bm"}),children:e.jsxs(m,{gap:"xs",children:[p?e.jsx(D,{to:`../type-${s==null?void 0:s.machine_type}`,text:p.name}):e.jsx(x,{children:s==null?void 0:s.machine_type}),s&&!p&&e.jsx(T,{})]})}),e.jsx(c,{name:i._({id:"3ADt1I"}),children:e.jsxs(m,{gap:"xs",children:[_?e.jsx(D,{to:`../driver-${s==null?void 0:s.driver}`,text:_.name}):e.jsx(x,{children:s==null?void 0:s.driver}),!(s!=null&&s.is_driver_available)&&e.jsx(T,{})]})}),e.jsx(c,{name:i._({id:"nsu9Un"}),children:e.jsx(J,{value:(s==null?void 0:s.initialized)||!1})}),e.jsx(c,{name:i._({id:"F6pfE9"}),children:e.jsx(J,{value:(s==null?void 0:s.active)||!1})}),e.jsx(c,{name:i._({id:"uAQUqI"}),children:e.jsxs(ne,{direction:"column",children:[(s==null?void 0:s.status)===-1?e.jsx(x,{fz:"xs",children:"No status"}):he({status:`${(s==null?void 0:s.status)||-1}`,type:`MachineStatus__${s==null?void 0:s.status_model}`}),e.jsx(x,{fz:"sm",children:s==null?void 0:s.status_text})]})}),e.jsxs(m,{justify:"space-between",gap:"xs",children:[e.jsxs(x,{fz:"sm",fw:700,children:[e.jsx(M,{id:"UirGxE"}),":"]}),s&&(s==null?void 0:s.machine_errors.length)>0?e.jsx(L,{color:"red",style:{marginLeft:"10px"},children:s==null?void 0:s.machine_errors.length}):e.jsx(x,{fz:"xs",children:e.jsx(M,{id:"hIOaIF"})}),e.jsx(A,{w:"100%",children:s==null?void 0:s.machine_errors.map((F,se)=>e.jsx(A.Item,{children:e.jsx(U,{children:F})},se))})]})]})})})})]}),(s==null?void 0:s.is_driver_available)&&e.jsxs(d.Item,{value:"machine-settings",children:[e.jsx(d.Control,{children:e.jsx(w,{size:"lg",children:i._({id:"m57e2B"})})}),e.jsx(d.Panel,{children:e.jsx(k,{withBorder:!0,children:e.jsx(H,{machinePk:r,configType:"M",onChange:C})})})]}),(s==null?void 0:s.is_driver_available)&&e.jsxs(d.Item,{value:"driver-settings",children:[e.jsx(d.Control,{children:e.jsx(w,{size:"lg",children:i._({id:"fWJCep"})})}),e.jsx(d.Panel,{children:e.jsx(k,{withBorder:!0,children:e.jsx(H,{machinePk:r,configType:"D",onChange:C})})})]})]})]})})}function ee({props:r,renderMachineDrawer:o=!0,createProps:l}){const{machineTypes:s,machineDrivers:a}=W(),t=G("machine"),h=S(),f=u.useMemo(()=>[{accessor:"name",sortable:!0,render:n=>e.jsxs(m,{justify:"left",wrap:"nowrap",children:[e.jsx(P,{machine:n}),e.jsx(x,{children:n.name}),n.restart_required&&e.jsx(L,{color:"red",children:e.jsx(M,{id:"dKwnjv"})})]})},{accessor:"machine_type",sortable:!0,render:n=>{const v=s==null?void 0:s.find(z=>z.slug===n.machine_type);return e.jsxs(m,{gap:"xs",children:[e.jsx(x,{children:v?v.name:n.machine_type}),s&&!v&&e.jsx(T,{})]})}},{accessor:"driver",sortable:!0,render:n=>{const v=a==null?void 0:a.find(z=>z.slug===n.driver);return e.jsxs(m,{gap:"xs",children:[e.jsx(x,{children:v?v.name:n.driver}),!n.is_driver_available&&e.jsx(T,{})]})}},$({accessor:"initialized"}),$({accessor:"active"}),{accessor:"status",sortable:!1,render:n=>{const v=pe(`MachineStatus__${n.status_model}`);if(v&&n.status!==-1)return v(n)}}],[s]),[g,j]=u.useState(null),p=u.useMemo(()=>a?a.filter(n=>n.machine_type===g).map(n=>({value:n.slug,display_name:n.name})):[],[a,g]),_=ae({title:i._({id:"kZ/tbb"}),url:y.machine_list,fields:{name:{},machine_type:{hidden:!!(l!=null&&l.machine_type),...l!=null&&l.machine_type?{value:l.machine_type}:{},field_type:"choice",choices:s?s.map(n=>({value:n.slug,display_name:n.name})):[],onValueChange:n=>j(n)},driver:{hidden:!!(l!=null&&l.driver),...l!=null&&l.driver?{value:l.driver}:{},field_type:"choice",disabled:!g,choices:p},active:{}},onFormSuccess:n=>{t.refreshTable(),h(o?`machine-${n.pk}/`:`../machine-${n.pk}/`)},onClose:()=>{j(null)}}),C=u.useMemo(()=>[e.jsx(de,{tooltip:i._({id:"kZ/tbb"}),onClick:()=>{j(null),_.open()}},"add-machine")],[_.open]);return e.jsxs(e.Fragment,{children:[_.modal,o&&e.jsx(Y,{title:i._({id:"YDOU4Q"}),size:"xl",renderContent:n=>!n||!n.startsWith("machine-")?!1:e.jsx(_e,{machinePk:n.replace("machine-",""),refreshTable:t.refreshTable})}),e.jsx(O,{url:I(y.machine_list),tableState:t,columns:f,props:{...r,enableDownload:!1,onRowClick:n=>h(o?`machine-${n.pk}/`:`../machine-${n.pk}/`),tableActions:C,params:{...r.params},tableFilters:[{name:"active",label:i._({id:"F6pfE9"}),type:"boolean"},{name:"machine_type",label:i._({id:"pwL+bm"}),type:"choice",choiceFunction:()=>s?s.map(n=>({value:n.slug,label:n.name})):[]},{name:"driver",label:i._({id:"6ccUsd"}),type:"choice",choiceFunction:()=>a?a.map(n=>({value:n.slug,label:n.name})):[]}]}})]})}function me({machineTypeSlug:r}){var g,j,p;const o=S(),{machineTypes:l,refresh:s,isFetching:a}=W({includeDrivers:!1}),t=u.useMemo(()=>l==null?void 0:l.find(_=>_.slug===r),[l,r]),h=G("machineDrivers"),f=u.useMemo(()=>[{accessor:"name",title:i._({id:"6YtxFj"})},{accessor:"description",title:i._({id:"Nu4oKW"})},$({accessor:"is_builtin",title:i._({id:"argeGI"})})],[]);return e.jsx(e.Fragment,{children:e.jsxs(b,{children:[e.jsx(m,{wrap:"nowrap",children:e.jsx(B,{order:4,children:t?t.name:r})}),!t&&e.jsx(R,{color:"red",title:i._({id:"pAtylB"}),icon:e.jsx(le,{}),children:e.jsx(x,{children:i._({id:"FW2Ygg"})})}),e.jsxs(d,{multiple:!0,defaultValue:["machine-type-info","machine-drivers"],children:[e.jsxs(d.Item,{value:"machine-type-info",children:[e.jsx(d.Control,{children:e.jsx(w,{size:"lg",children:i._({id:"RRr8s4"})})}),e.jsx(d.Panel,{children:e.jsx(k,{withBorder:!0,children:e.jsxs(b,{pos:"relative",gap:"xs",children:[e.jsx(N,{visible:a,overlayProps:{opacity:0}}),e.jsx(c,{name:i._({id:"6YtxFj"}),value:t==null?void 0:t.name,type:"text"}),e.jsx(c,{name:i._({id:"L85WcV"}),value:t==null?void 0:t.slug,type:"text"}),e.jsx(c,{name:i._({id:"Nu4oKW"}),value:t==null?void 0:t.description,type:"text"}),!(t!=null&&t.is_builtin)&&e.jsx(c,{name:i._({id:"umAemZ"}),value:(g=t==null?void 0:t.provider_plugin)==null?void 0:g.name,type:"text",link:((j=t==null?void 0:t.provider_plugin)==null?void 0:j.pk)!==null?`../../plugin/${(p=t==null?void 0:t.provider_plugin)==null?void 0:p.pk}/`:void 0,detailDrawerLink:!0}),e.jsx(c,{name:i._({id:"jfVQG5"}),value:t==null?void 0:t.provider_file,type:"code"}),e.jsx(c,{name:i._({id:"++LBSt"}),value:t==null?void 0:t.is_builtin,type:"boolean"})]})})})]}),e.jsxs(d.Item,{value:"machine-drivers",children:[e.jsx(d.Control,{children:e.jsx(w,{size:"lg",children:i._({id:"qTGFbM"})})}),e.jsx(d.Panel,{children:e.jsx(k,{withBorder:!0,children:e.jsx(O,{url:I(y.machine_driver_list),tableState:h,columns:f,props:{dataFormatter:_=>_.filter(C=>C.machine_type===r),enableDownload:!1,enableSearch:!1,onRowClick:_=>o(`../driver-${_.slug}/`)}})})})]})]})]})})}function fe({machineDriverSlug:r}){var f,g,j;const{machineDrivers:o,machineTypes:l,refresh:s,isFetching:a}=W(),t=u.useMemo(()=>o==null?void 0:o.find(p=>p.slug===r),[o,r]),h=u.useMemo(()=>l==null?void 0:l.find(p=>p.slug===(t==null?void 0:t.machine_type)),[o,l]);return e.jsxs(b,{children:[e.jsx(m,{justify:"center",children:e.jsx(B,{order:4,children:t?t.name:r})}),!t&&e.jsx(x,{style:{fontStyle:"italic"},children:e.jsx(M,{id:"p6inm0"})}),e.jsx(k,{withBorder:!0,children:e.jsxs(b,{gap:"md",children:[e.jsxs(m,{justify:"space-between",children:[e.jsx(B,{order:4,children:e.jsx(M,{id:"Dm7Jy5"})}),e.jsx(X,{variant:"outline",onClick:()=>s(),children:e.jsx(K,{})})]}),e.jsxs(b,{pos:"relative",gap:"xs",children:[e.jsx(N,{visible:a,overlayProps:{opacity:0}}),e.jsx(c,{name:i._({id:"6YtxFj"}),value:t==null?void 0:t.name,type:"text"}),e.jsx(c,{name:i._({id:"L85WcV"}),value:t==null?void 0:t.slug,type:"text"}),e.jsx(c,{name:i._({id:"Nu4oKW"}),value:t==null?void 0:t.description,type:"text"}),e.jsx(c,{name:i._({id:"I+nMNp"}),value:h?h.name:t==null?void 0:t.machine_type,type:"text",link:h?`../type-${t==null?void 0:t.machine_type}`:void 0,detailDrawerLink:!0}),!(t!=null&&t.is_builtin)&&e.jsx(c,{name:i._({id:"umAemZ"}),value:(f=t==null?void 0:t.provider_plugin)==null?void 0:f.name,type:"text",link:((g=t==null?void 0:t.provider_plugin)==null?void 0:g.pk)!==null?`../../plugin/${(j=t==null?void 0:t.provider_plugin)==null?void 0:j.pk}/`:void 0,detailDrawerLink:!0}),e.jsx(c,{name:i._({id:"jfVQG5"}),value:t==null?void 0:t.provider_file,type:"code"}),e.jsx(c,{name:i._({id:"++LBSt"}),value:t==null?void 0:t.is_builtin,type:"boolean"}),e.jsxs(m,{justify:"space-between",gap:"xs",children:[e.jsxs(x,{fz:"sm",fw:700,children:[e.jsx(M,{id:"UirGxE"}),":"]}),t&&(t==null?void 0:t.driver_errors.length)>0?e.jsx(L,{color:"red",style:{marginLeft:"10px"},children:t.driver_errors.length}):e.jsx(x,{fz:"xs",children:e.jsx(M,{id:"hIOaIF"})}),e.jsx(A,{w:"100%",children:t==null?void 0:t.driver_errors.map((p,_)=>e.jsx(A.Item,{children:e.jsx(U,{children:p})},`${_}-${p}`))})]})]})]})}),e.jsx(k,{withBorder:!0,children:e.jsxs(b,{gap:"md",children:[e.jsx(B,{order:4,children:e.jsx(M,{id:"Qf5DYN"})}),e.jsx(ee,{props:{params:{driver:r}},renderMachineDrawer:!1,createProps:{machine_type:t==null?void 0:t.machine_type,driver:r}})]})})]})}function ge({props:r}){const o=G("machineTypes"),l=S(),s=u.useMemo(()=>[{accessor:"name",title:i._({id:"6YtxFj"})},{accessor:"description",title:i._({id:"Nu4oKW"})},$({accessor:"is_builtin",title:i._({id:"eBtH/D"})})],[]);return e.jsxs(e.Fragment,{children:[e.jsx(Y,{title:i._({id:"qRwuAd"}),size:"xl",renderContent:a=>!a||!a.startsWith("type-")?!1:e.jsx(me,{machineTypeSlug:a.replace("type-","")})}),e.jsx(Y,{title:i._({id:"RYeia3"}),size:"xl",renderContent:a=>!a||!a.startsWith("driver-")?!1:e.jsx(fe,{machineDriverSlug:a.replace("driver-","")})}),e.jsx(O,{url:I(y.machine_types_list),tableState:o,columns:s,props:{...r,enableDownload:!1,enableSearch:!1,onRowClick:a=>l(`type-${a.slug}/`),params:{...r.params}}})]})}function Se(){var s;const{data:r,refetch:o}=E({queryKey:["machine-registry-status"],queryFn:()=>q.get(I(y.machine_registry_status)).then(a=>a.data),staleTime:1e4}),l=u.useMemo(()=>(r==null?void 0:r.registry_errors)&&r.registry_errors.length>0,[r]);return e.jsxs(d,{multiple:!0,defaultValue:["machinelist","machinetypes"],children:[e.jsxs(d.Item,{value:"machinelist",children:[e.jsx(d.Control,{children:e.jsx(w,{size:"lg",children:i._({id:"Qf5DYN"})})}),e.jsx(d.Panel,{children:e.jsx(ee,{props:{}})})]}),e.jsxs(d.Item,{value:"machinetypes",children:[e.jsx(d.Control,{children:e.jsx(w,{size:"lg",children:i._({id:"XyzprV"})})}),e.jsx(d.Panel,{children:e.jsx(ge,{props:{}})})]}),e.jsxs(d.Item,{value:"machineerrors",children:[e.jsx(d.Control,{children:e.jsx(w,{size:"lg",children:i._({id:"Y7d3OC"})})}),e.jsx(d.Panel,{children:e.jsxs(b,{gap:"xs",children:[e.jsxs(m,{justify:"space-beteen",wrap:"nowrap",style:{width:"100%"},children:[l?e.jsx(R,{flex:10,color:"red",title:i._({id:"iXdfqc"}),icon:e.jsx(Z,{}),children:e.jsx(x,{children:i._({id:"2U2qZc"})})}):e.jsx(R,{flex:10,color:"green",title:i._({id:"32TD49"}),icon:e.jsx(Z,{}),children:e.jsx(x,{children:i._({id:"Jb0bCL"})})}),e.jsx(X,{variant:"outline",onClick:()=>o(),children:e.jsx(K,{})})]}),l&&e.jsx(A,{children:(s=r==null?void 0:r.registry_errors)==null?void 0:s.map((a,t)=>e.jsx(A.Item,{children:e.jsx(U,{children:a.message})},t))})]})})]})]})}export{Se as default};
